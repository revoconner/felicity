<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .min-photos-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .min-photos-input {
            width: 80px;
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            color: #e0e0e0;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .min-photos-input:focus {
            border-color: #3b82f6;
            background: #0d0d0d;
        }
        
        .min-photos-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="title-bar">
        <div class="title-bar-drag pywebview-drag-region">
            <div class="title-bar-title">Face Recognition Photo Organizer</div>
        </div>
        <div class="title-bar-controls">
            <button class="title-bar-btn minimize-btn" id="minimizeBtn" title="Minimize">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <rect x="0" y="5" width="12" height="2" fill="currentColor"/>
                </svg>
            </button>
            <button class="title-bar-btn maximize-btn" id="maximizeBtn" title="Maximize">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <rect x="1" y="1" width="10" height="10" fill="none" stroke="currentColor" stroke-width="1.5"/>
                </svg>
            </button>
            <button class="title-bar-btn close-btn" id="closeBtn" title="Close">
                <svg width="12" height="12" viewBox="0 0 12 12">
                    <path d="M1 1 L11 11 M11 1 L1 11" stroke="currentColor" stroke-width="1.5"/>
                </svg>
            </button>
        </div>
    </div>
    <div class="app-container" id="appContainer">
        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title-row">
                        <div class="sidebar-title">People</div>
                        <div class="sidebar-controls">
                            <button class="icon-btn" id="filterBtn" title="Filter">
                                <div class="doner-icon">
                                    <div class="doner-line"></div>
                                    <div class="doner-line"></div>
                                    <div class="doner-line"></div>
                                </div>
                            </button>
                            <button class="icon-btn" id="jumpToBtn" title="Jump to">
                                <div class="bento-icon">
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                    <div class="bento-dot"></div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="people-list" id="peopleList"></div>
            </div>

            <div class="content-area">
                <div class="content-header">
                    <div class="content-title" id="contentTitle">Select a person</div>
                    <div class="content-controls">
                        <div class="size-control">
                            <span class="size-label">Size:</span>
                            <input type="range" class="size-slider" id="sizeSlider" min="100" max="300" value="180">
                        </div>
                        <select class="view-dropdown" id="viewModeDropdown">
                            <option value="entire_photo">Show entire photo</option>
                            <option value="zoom_to_faces">Zoom to tagged faces</option>
                        </select>
                    </div>
                </div>
                <div class="photo-grid-container">
                    <div class="photo-grid" id="photoGrid"></div>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="bottom-content">
                <button class="settings-btn" id="openSettingsBtn">Settings</button>
                <div class="progress-section" id="progressSection">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing...</div>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-info" id="statusInfo">
                    <span class="status-badge">
                        <span class="status-indicator"></span>
                        <span id="pytorchVersion">PyTorch</span>
                    </span>
                    <span id="gpuStatus">Checking...</span>
                    <span id="cudaVersion">CUDA: N/A</span>
                    <span id="faceCount">Found: 0 faces</span>
                </div>
                <button class="help-btn" id="openHelpBtn" title="Quick Help">
                    <svg width="14" height="14" viewBox="0 0 14 14">
                        <circle cx="7" cy="7" r="6" fill="none" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M5 5.5 C5 4 6 3.5 7 3.5 C8 3.5 9 4 9 5.5 C9 6.5 8 7 7 7 L7 8.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
                        <circle cx="7" cy="10.5" r="0.5" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="noFoldersOverlay">
        <div class="no-folders-container" id="noFoldersContainer">
            <div class="no-folders-content">
                <div class="no-folders-icon">
                    <svg width="64" height="64" viewBox="0 0 64 64">
                        <path d="M8 16 L28 16 L32 20 L56 20 L56 52 L8 52 Z" fill="none" stroke="#3b82f6" stroke-width="3"/>
                        <path d="M20 32 L44 32 M32 24 L32 40" stroke="#3b82f6" stroke-width="3"/>
                    </svg>
                </div>
                <div class="no-folders-title">No Folders to Scan</div>
                <div class="no-folders-message">Please add some folders to scan for photos to continue</div>
                <button class="no-folders-btn" id="goToFoldersBtn">Take me to settings</button>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-container" id="settingsContainer">
            <div class="settings-sidebar">
                <div class="settings-header">
                    <div class="settings-title">Settings</div>
                </div>
                
                <div class="settings-nav">
                    <div class="nav-item active" data-panel="general">General Settings</div>
                    <div class="nav-item" data-panel="folders">Folders to Scan</div>
                    <div class="nav-item" data-panel="log">View Log</div>
                </div>
                
                <div class="settings-footer">
                    <button class="close-settings-btn" id="closeSettingsBtn">Close Settings</button>
                    <div class="footer-credit">For personal use only - Free license</br>Version: 0.7.0.b</div>
                </div>
            </div>
            
            <div class="settings-content">
                <div class="content-panel active" id="general-panel">
                    <div class="panel-title">General Settings</div>
                    
                    <div class="setting-group">
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Threshold</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Change threshold values for the AI to detect faces, higher values = stricter match, so similar looking faces will be scrutinized better, but it also may end up creating more persons for different lighting conditions. Default 50%</div>
                                </span>
                            </div>
                            <div class="threshold-control">
                                <div class="threshold-slider-wrapper">
                                    <input type="range" class="threshold-slider" id="thresholdSlider" 
                                           min="10" max="90" value="50">
                                    <span class="threshold-value" id="thresholdValue">50%</span>
                                </div>
                                <button class="recalibrate-btn" id="recalibrateBtn">Recalibrate</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Use system resources dynamically</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Smartly uses system resources to not hinder user's task. When enabled, limits CPU usage when app is minimised to system tray, and uses all resources when cpu is running in desktop mode. When disabled, the app will perform faster at the cost of fully utilizing system's resources. Default On.</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dynamicResourcesToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show single unmatched images</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Faces that have no matches with any other image are hidden by default, as they are likely images users do not care about. Show them grouped under UNMATCHED FACES. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showUnmatchedToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Hide persons with less than</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Hide persons from the list who have fewer than the specified number of photos. Useful to filter out people who only appear once or twice. Set to 0 or toggle off, to disable. Default Off with 2 photos</div>
                                </span>
                            </div>
                            <div class="min-photos-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="minPhotosToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                                <input type="number" class="min-photos-input" id="minPhotosInput" 
                                       min="0" max="999" value="2" disabled>
                                <span style="color: #a0a0a0; font-size: 13px;">photos</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show face tags in full screen image previews</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Use this to see person's name in the photo so you know where they are tagged in, for example, in a group photo or in the background. Default On</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showFaceTagsPreviewToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Close to tray</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Keeps the program running in system's tray when closed, to quit right click the tray icon and select quit. Default On</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="closeToTrayToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show hidden person</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">People hidden from the list by the user will shown in the list again as long as this is turned on. You can unhide individual names from the list once visible. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showHiddenToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show hidden photos</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Photos hidden by the user will be shown with diagonal grid lines when this toggle is on. You can unhide individual photos from the photo grid menu once visible. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showHiddenPhotosToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Hide unnamed persons</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Hides all the people from the list whom you have not renamed yet. Remember if this is the first time you are scanning, you must turn this off to see new people before you can rename them. This will not hide Unmatched Faces. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="hideUnnamedToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        

                            <div class="setting-row">
                                <div class="setting-label">
                                    <span>Find changes in photos in the drive</span>
                                    <span class="info-icon">
                                        i
                                        <div class="tooltip">Every time the app restarts, it searches for new photos or removes old photos from the database which has been deleted to keep in sync with your drive. This results in a slow start. If you do make a lot of changes to your photos library, you can set a threshold of time before it rescans for changes after a restart. If set to manually you will have to go to "Folders to Scan" section and click the rescan button.</div>
                                    </span>
                                </div>
                                <select class="view-dropdown" id="scanFrequencyDropdown" style="min-width: 200px;">
                                    <option value="every_restart">After Every restart</option>
                                    <option value="restart_1_day" selected>On Every Restart after 1 day</option>
                                    <option value="restart_1_week">On Every Restart after 1 week</option>
                                    <option value="manual">Manually (Not Recommended)</option>
                                </select>
                            </div>

                        
                        <div class="setting-row">
                            <div class="setting-label">
                                <span>Show development options</span>
                                <span class="info-icon">
                                    i
                                    <div class="tooltip">Shows internal tagging statistics and advanced options for debugging. Regular users should keep this off. Default Off</div>
                                </span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showDevOptionsToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-group">
                            <div class="setting-row">
                                <div class="setting-label">
                                    <span>Thumbnail Cache</span>
                                    <span class="info-icon">
                                        i
                                        <div class="tooltip">Cached thumbnails speed up photo loading dramatically. First load generates cache, subsequent loads are instant. Clear cache if photos have been edited externally.</div>
                                    </span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span id="cacheSize" style="color: #a0a0a0; font-size: 13px;">Calculating...</span>
                                    <button class="recalibrate-btn" id="clearCacheBtn" onclick="clearThumbnailCache()">Clear Cache</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="content-panel" id="folders-panel">
                    <div class="panel-title">Folders to Scan</div>
                    
                    <div class="folder-section">
                        <div class="folder-section-title">
                            <span>Include folders for scanning</span>
                            <span class="info-icon">
                                i
                                <div class="tooltip">Include all folders that will be scanned for photos. Add folders here that contains photos. Supported: jpg, png, bmp, gif, heic, heif</div>
                            </span>
                        </div>
                        <div class="folder-list-container" id="includeFolders">
                            <div style="color: #606060; padding: 12px; text-align: center; font-size: 13px;">No folders added yet</div>
                        </div>
                        <div class="folder-controls">
                            <button class="folder-btn" id="addIncludeBtn">
                                <span>+</span>
                                <span>Add Folder</span>
                            </button>
                            <button class="folder-btn remove" id="removeIncludeBtn">
                                <span>-</span>
                                <span>Remove Folder</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="folder-section">
                        <div class="folder-section-title">
                            <span>Exclude subfolders from scanning</span>
                            <span class="info-icon">
                                i
                                <div class="tooltip">Exclude subfolders of "included folders" above, that are not to be scanned. This takes precedence over include folders, so if you add the same folder to both, they will not be scanned</div>
                            </span>
                        </div>
                        <div class="folder-list-container" id="excludeFolders">
                            <div style="color: #606060; padding: 12px; text-align: center; font-size: 13px;">No folders excluded yet</div>
                        </div>
                        <div class="folder-controls">
                            <button class="folder-btn" id="addExcludeBtn">
                                <span>+</span>
                                <span>Add Folder</span>
                            </button>
                            <button class="folder-btn remove" id="removeExcludeBtn">
                                <span>-</span>
                                <span>Remove Folder</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="folder-section">
                        <div class="folder-section-title">
                            <span>Wildcard Exclusion</span>
                            <span class="info-icon">
                                i
                                <div class="tooltip">Use wildcards like *.jpg, *.gif with extension names or *thumbnail with folder names to exclude them from being scanned, separated by commas</div>
                            </span>
                        </div>
                        <input type="text" class="wildcard-input" id="wildcardInput" placeholder="e.g., *.gif, *thumbnail, *cache*, C:\Photos\private photos ">
                    </div>
                    
                    <div class="folder-section">
                        <button class="recalibrate-btn" id="rescanBtn" style="width: 100%; padding: 12px;">Rescan For Changes</button>
                    </div>
                </div>
                
                <div class="content-panel" id="log-panel">
                    <div class="log-header">
                        <div class="panel-title">View Log</div>
                        <button class="save-log-btn" id="saveLogBtn">
                            <span>Save Log</span>
                        </button>
                    </div>
                    
                    <div class="log-viewer" id="logViewer">
                        <div class="log-entry">Application started</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-overlay" id="helpOverlay">
        <div class="help-container" id="helpContainer">
            <div class="help-content">
                <div class="help-title">Quick Help</div>
                
                <div class="help-list">
                    <div class="help-item">Single click the image to bring up a preview inside the app</div>
                    <div class="help-item">Double click the image to open it in your default image viewer app</div>
                    <div class="help-item">By default the person's detected are named person 1, person 2 and so on.</br>Use rename option in the person's menu to rename them</div>
                    <div class="help-item">Once renamed their default preview photo can be changed</div>
                    <div class="help-item">If you want to see the person that is tagged in the image (say in a group photo) use the drop down above</div>
                    <div class="help-item">You can hide a person from the list, to unhide, show all hidden person in general settings</div>
                    <div class="help-item">Select multiple photos by pressing and holding CTRL or SHIFT key</div>
                    <div class="help-item">You can hide a photo from the grid, to unhide, show all hidden photos in general settings</div>
                    <div class="help-item">User remove/transfer tag in the photo thumbnail to transfer that photo to other person (someone you have named)</div>
                    <div class="help-item">Photo scan be CPU intensive task, to reduce cpu usage, close to tray during scan</div>
                    <div class="help-item">To add more folders or remove folders, as well as exclude subfolders where photos are, do so in the settings</div>
                    <div class="help-item">Any images that are added to disk, or removed from disk will be scanned at next restart,</br> or on the next restart after a day, or a week, or manually. You can change the frequency in settings</div>
                </div>
                
                <button class="close-help-btn" id="closeHelpBtn" style="max-width: 20%;">Close Quick Help</button>
            </div>
        </div>
    </div>

    <div class="lightbox-overlay" id="lightboxOverlay">
        <button class="lightbox-close" id="lightboxClose">
            <svg width="24" height="24" viewBox="0 0 24 24">
                <path d="M2 2 L22 22 M22 2 L2 22" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        
        <button class="lightbox-nav lightbox-prev" id="lightboxPrev">
            <svg width="32" height="32" viewBox="0 0 32 32">
                <path d="M20 4 L8 16 L20 28" stroke="currentColor" stroke-width="3" fill="none"/>
            </svg>
        </button>
        
        <div class="lightbox-content" id="lightboxContent">
            <img src="" alt="Preview" id="lightboxImage">
            <div class="face-tags-overlay" id="faceTagsOverlay"></div>
        </div>
        
        <button class="lightbox-nav lightbox-next" id="lightboxNext">
            <svg width="32" height="32" viewBox="0 0 32 32">
                <path d="M12 4 L24 16 L12 28" stroke="currentColor" stroke-width="3" fill="none"/>
            </svg>
        </button>
        
        <div class="lightbox-counter" id="lightboxCounter">1 of 1</div>
        
        <div class="lightbox-actions">
            <button class="lightbox-action-btn" id="lightboxOpenExternal" title="Open in default app">
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <path d="M10 2 L10 12 M10 2 L6 6 M10 2 L14 6" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="2" y="12" width="16" height="6" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="cleanup-overlay" id="cleanupOverlay">
        <div class="cleanup-message">
            <div class="cleanup-title">Cleaning up and quitting</div>
        </div>
    </div>

    <div class="cleanup-overlay" id="renameOverlay">
        <div class="cleanup-message" id="renameDialog">
            <div class="cleanup-title" id="renameTitle">Rename Person</div>
            <div class="rename-input-container">
                <input type="text" class="wildcard-input" id="renameInput" placeholder="Enter new name">
            </div>
            <div class="folder-controls" style="justify-content: center; margin-top: 24px;">
                <button class="folder-btn" id="renameConfirmBtn">
                    <span>Confirm</span>
                </button>
                <button class="folder-btn remove" id="renameCancelBtn">
                    <span>Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <div class="cleanup-overlay" id="nameConflictOverlay">
        <div class="name-conflict-message" id="nameConflictDialog">
            <div class="cleanup-title">Name Already Exists</div>
            <div class="conflict-warning">
                Warning: A person with the same name exists. If you keep the same name, these persons will merge in the next calibration.
            </div>
            <div class="conflict-question">Do you want to proceed?</div>
            <div class="conflict-buttons">
                <button class="conflict-btn proceed" id="conflictProceedBtn">
                    <span>Yes, merge them</span>
                </button>
                <button class="conflict-btn auto-rename" id="conflictAutoRenameBtn">
                    <span id="autoRenameText">Name them differently</span>
                </button>
                <button class="conflict-btn go-back" id="conflictGoBackBtn">
                    <span>Go back to rename</span>
                </button>
            </div>
        </div>
    </div>

    <div class="transfer-overlay" id="transferOverlay">
        <div class="transfer-dialog">
            <div class="transfer-title">Transfer Face To...</div>
            <div class="transfer-list" id="transferList">
            </div>
            <button class="transfer-cancel" id="transferCancelBtn">Cancel</button>
        </div>
    </div>

    <script src="ui_js_script.js"></script>
    <script src="virtual_scroll_grid.js"></script>

</body>
</html>
